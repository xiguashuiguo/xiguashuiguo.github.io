---
title: 前端构建系列一
date: 2024-04-23 11:13:11
tags:
  - 构建
  - 代码管理
categories:
  - 前端工程化
---

### 现状梳理
当前工作的项目环境比较复杂，所有项目代码分散在几个不同的代码仓库，同时项目所使用的技术框架以及部署环境还比较复杂。
#### 代码库
项目的代码库位于内网环境部署的gitee之上，本身较为不好用（相较于github而言）。同时各个代码库涉及技术栈不同，主要包括了以下
- react+vite的静态资源类型
- nextjs的带服务的类型
  两类，同时互相之间独立，没有办法沉淀公共代码。
#### 部署
部署方式主要分为了以下几种，
- 基于内网自有服务器的部署，主要使用宿主机nginx代理本机静态资源
- 基于阿里云的部署
  - mse网关代理oss静态资源
  - ACK容器服务部署next的pod
- 基于 AWS 的容器化部署

### 改进方案
#### 代码管理
代码管理层面，努力将所有代码收归一个代码库进行管理，同时为了兼顾之前的代码，最终采用`git submodule`加`turborepo`的方式进行管理，结构如下

	fe-monorepo/
	│
	├── apps/		此目录下为各个项目的代码库
	│   ├── app1/	app1相关代码
	│	│	└── package.json
	│   └── ...
	│
	├── packages/	此目录下为各个二方包存放地址
	│   ├── pkg1
	│   	└── package.json
	│   └── ...
	│
	├── cli/		此目录下为构建相关内容
	│   ├── dev/	dev 构建相关内容
	│   │
	│   └── ...
	│
	├── turbo.json		存放 turborepo 相关配置
	│
	├── pnpm-workspace.yaml		存放 monorepo 相关配置
	│
	├── .gitmodules		存放 gitsubmodule 相关配置
	│
	└── package.json


上面展示了大致的目录结构（不重要的相关文件略去）。

之前各个项目代码分散在不同的git仓库之中，导致了很多问题，如无法共享配置与规则、二方包无法共享等，当前前端的主流都在向monorepo方向发展，所以本次构建改造梳理，也是向着同样的趋势发展，所采用的技术栈主要是 [pnpm workspace](https://pnpm.io/zh/workspaces)以及 [turborepo](https://turbo.build/repo/docs)（不过鉴于目前的构建流程，turborepo 的许多缓存加速能力并没有用到，后续迭代再看）。

#### 部署相关
为了统一各个环境的部署任务，决定使用下面俩种方式
- 正式发布环境，统一使用容器化部署
- 自有服务器部署，统一提供静态资源

在正式发布的环境，所有都基于公有云打造，提供出前端统一Docker镜像，有助于抹平各个不同的云服务场景差异，提供一致的对外服务，减轻前端运维压力。而在内部测试环境，对服务器的控制权限较高，同时没有提供类似 k8s 的服务，运维也比较方便，这时候提供静态文件供各方使用即可（使用 next 开发的项目仍需要提供 node 镜像）。
